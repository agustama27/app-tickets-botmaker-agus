generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  LEAD
}

enum Status {
  NEW
  TRIAGED
  IN_PROGRESS
  WAITING_USER
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Area {
  id    String    @id @default(uuid())
  name  String
  teams Team[]
  users UserApp[]
}

model Team {
  id      String    @id @default(uuid())
  name    String
  area_id String?
  area    Area?     @relation(fields: [area_id], references: [id], onDelete: SetNull)
  users   UserApp[]
}

model UserApp {
  id         String    @id @default(uuid())
  name       String
  email      String    @unique
  role       Role
  area_id    String?
  team_id    String?
  area       Area?     @relation(fields: [area_id], references: [id], onDelete: SetNull)
  team       Team?     @relation(fields: [team_id], references: [id], onDelete: SetNull)
  created_at DateTime  @default(now())
  tickets    Ticket[]  @relation("AssignedTickets")
}

model Contact {
  phone      String    @id
  name       String?
  email      String?
  area_id    String?
  team_id    String?
  channel_id String?
  chat_id    String?
  first_seen DateTime?
  last_seen  DateTime?
  tickets    Ticket[]
}

model Ticket {
  id               String        @id @default(uuid())
  contact_phone    String?
  contact          Contact?      @relation(fields: [contact_phone], references: [phone], onDelete: SetNull)
  chat_id          String?
  channel_id       String?
  type             String?
  tag              String?
  status           Status        @default(NEW)
  priority         Priority      @default(MEDIUM)
  area_id          String?
  team_id          String?
  assigned_user_id String?
  assignedTo       UserApp?      @relation("AssignedTickets", fields: [assigned_user_id], references: [id], onDelete: SetNull)
  opened_at        DateTime      @default(now())
  closed_at        DateTime?
  last_message_at  DateTime?
  messages         Message[]
  events           TicketEvent[]
}

model Message {
  id                  String   @id @default(uuid())
  ticket_id           String
  ticket              Ticket   @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  direction           String
  text                String?
  media_url           String?
  botmaker_message_id String?
  at                  DateTime @default(now())
}

model TicketEvent {
  id         String   @id @default(uuid())
  ticket_id  String
  ticket     Ticket   @relation(fields: [ticket_id], references: [id], onDelete: Cascade)
  event_type String
  payload    Json?
  created_at DateTime @default(now())
}

